<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="/css/admin/userManage.css">
</head>
<body>
    <div class="topnav">
        <a href="/"><img src="/public/logo.png" alt="Logo"></a>
        <a href="/Admin/Statistical">Th·ªëng k√™</a>
        <a class="active" href="/Admin/Users">T√†i kho·∫£n</a>
        <a href="/Admin/Novels">Ti·ªÉu thuy·∫øt</a>
        <a href="/Admin/Genres">Th·ªÉ lo·∫°i</a>
        <a href="/Admin/Transactions">Giao d·ªãch</a>
        <a href="/Admin/Discussions">B√†i th·∫£o lu·∫≠n</a>
        <a href="/Admin/Reports">B√°o c√°o</a>
        <a href="/Admin/SubscriptionPlans">G√≥i ƒë·ªçc</a>
        <div class="user-menu">
            <% if (typeof currentUser !== 'undefined' && currentUser) { %>
                <% if (currentUser.role === 'admin') { %>
                    <a href="/Admin/Users">Qu·∫£n l√Ω</a>
                <% } %>
                <a href="/user/profile/<%= currentUser.id %>">C√° nh√¢n</a>
                <a href="/user/logout">ƒêƒÉng xu·∫•t</a>
            <% } else { %>
                <a href="/login">ƒêƒÉng nh·∫≠p</a>
                <a href="/register">ƒêƒÉng k√Ω</a>
            <% } %>
        </div> 
    </div>
    <div class="table-container">
        <div class="title">Danh s√°ch t√†i kho·∫£n</div>
        <!-- üîç Thanh t√¨m ki·∫øm -->
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo t√†i kho·∫£n..." value="<%= searchQuery || '' %>">
        <button onclick="searchUsers()">T√¨m</button>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n</th>
                    <th>Email</th>
                    <th>Ph√¢n quy·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y t·∫°o</th>
                    <th>Action</th>
                </tr>
            </thead>
            <button onclick="openFormAdd()">Th√™m Ng∆∞·ªùi D√πng</button>

<div id="userFormAdd" class="overlay" style="display: none;">
    <div class="popup">
        <form action="/Admin/create-user" method="post">
            <fieldset>
                <legend>Th√™m Ng∆∞·ªùi D√πng</legend>

                <div class="input-group">
                    <label>Email:</label>
                    <input type="email" name="email" required>
                </div>
                <div class="input-group">
                    <label>T√†i kho·∫£n:</label>
                    <input type="text" name="username" required>
                </div>
                <div class="input-group">
                    <label>M·∫≠t kh·∫©u:</label>
                    <input type="password" name="password" required>
                </div>
                <div>
                    <button type="submit">L∆∞u</button>
                    <button type="button" onclick="closeFormAdd()">ƒê√≥ng</button>
                </div>
            </fieldset>
        </form>
    </div>
</div>
            <tbody id="userTableBody">
                <% listUsers.forEach(user => { %>
                    <tr>
                        <td><%= user.UserID %></td>
                        <td><%= user.Username %></td>
                        <td><%= user.Email %></td>
                        <td><%= user.Role %></td>
                        <td><%= user.Status %></td>
                        <td><%= user.CreatedAt %></td>
                        <td>
                            <button onclick="openFormUpdate(<%= user.UserID %>, '<%= user.Email %>', '<%= user.Username %>')">S·ª≠a</button>
                            <button onclick="deleteUser(<%= user.UserID %>)">X√≥a</button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
            <!-- Form S·ª≠a Ng∆∞·ªùi D√πng (·∫®n m·∫∑c ƒë·ªãnh) -->
<div id="userFormUpdate" class="overlay" style="display: none;">
    <div class="popup">
        <form action="/Admin/update-user" method="post">
            <fieldset>
                <legend>S·ª≠a th√¥ng tin ng∆∞·ªùi D√πng</legend>

                <!-- ID (·∫®n ƒëi) -->
                <input type="hidden" name="userID" id="updateUserID">

                <div class="input-group">
                    <label>Email:</label>
                    <input type="text" name="email" id="updateEmail">
                </div>
                <div class="input-group">
                    <label>T√†i kho·∫£n:</label>
                    <input type="text" name="username" id="updateUsername">
                </div>
                <div class="input-group">
                    <label>Ph√¢n quy·ªÅn:</label>
                    <select name="role" id="updateRole">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tr·∫°ng th√°i:</label>
                    <select name="status" id="updateStatus">
                        <option value="active">Active</option>
                        <option value="banned">Banned</option>
                    </select>
                </div>
                <div>
                    <button type="submit">L∆∞u</button>
                    <button type="button" onclick="closeFormUpdate()">ƒê√≥ng</button>
                </div>
            </fieldset>
        </form>
    </div>
</div>

        </table>
    </div>
    <script>
        function deleteUser(userID) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y?")) return;

    console.log("G·ª≠i request x√≥a userID:", userID);

    fetch('/Admin/delete-user', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userID })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => {
        console.error("L·ªói:", error);
        alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
    });
}


function openFormAdd() {
    document.getElementById("userFormAdd").style.display = "block";
}

function closeFormAdd() {
    document.getElementById("userFormAdd").style.display = "none";
}

function openFormUpdate(userID, email, username) {
    document.getElementById("updateUserID").value = userID;
    document.getElementById("updateEmail").value = email;
    document.getElementById("updateUsername").value = username;
    document.getElementById("userFormUpdate").style.display = "flex";
}

function closeFormUpdate() {
    document.getElementById("userFormUpdate").style.display = "none";
}

function searchUsers() {
    const searchValue = document.getElementById("searchInput").value;

    fetch(`/Admin/search-users?query=${encodeURIComponent(searchValue)}`, {
        headers: { "Accept": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        const tableBody = document.getElementById("userTableBody");
        tableBody.innerHTML = "";

        data.forEach(user => {
            const row = `
                <tr>
                    <td>${user.UserID}</td>
                    <td>${user.Username}</td>
                    <td>${user.Email}</td>
                    <td>${user.Role}</td>
                    <td>${user.Status}</td>
                    <td>${user.CreatedAt}</td>
                    <td>
                        <button onclick="openFormUpdate(${user.UserID}, '${user.Email}', '${user.Username}')">S·ª≠a</button>
                        <button onclick="deleteUser(${user.UserID})">X√≥a</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    })
    .catch(error => console.error("L·ªói t√¨m ki·∫øm:", error));
}

        </script>
</body>
</html>